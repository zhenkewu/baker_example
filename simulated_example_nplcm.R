#######################################################################
# Simulated Examples for Nested Partially-Latent Class Models
# Zhenke Wu | zhenkewu@gmail.com
# Februrary 16, 2016
# 1. must have installed JAGS;
# 2. must specify working_dir;
# 3. must have "pathogen_category_simulation.csv" under working_dir; can
#    download here (https://goo.gl/XMufWr)
# 4. the program will produce a folder within working_dir containing figures, 
#    posterior results along with information about model and priors.
# Note: the example will only run 100 Gibbs sampling steps to save computing time.
# To produce useful posterior inferences, please modify "mcmc_options" as follows
#                      "n.itermcmc" to 50000
#                      "n.burnin"   to 10000,
#                      "n.thin"     to 40,
#######################################################################

rm(list=ls())
library(baker)

# parent directory for testing code:
working_dir <- "~/Downloads/run_baker_example"
dir.create(working_dir)

K.true  <- 2   # no. of latent subclasses in actual simulation. 
# If eta = c(1,0), K.true is effectively 1.
J       <- 6   # no. of pathogens.
N       <- 500 # no. of cases/controls.

# case subclass weight (five values):
subclass_mix_seq <- c(0,0.25,0.5,0.75,1)


NREP   <- 100
MYGRID <- expand.grid(list(rep   = 1:NREP, # data replication.
                           iter  = seq_along(subclass_mix_seq),# mixing weights.
                           k_fit = c(1,2), # model being fitted: 1 for pLCM; >1 for npLCM.
                           scn   = 3:1)    # index for different truth; see "scn_collection.R".
)

n_seed   <- nrow(unique(MYGRID[,-3]))
seed_seq <- rep(1:n_seed,times=length(unique(MYGRID[,3])))

SEG   <- 1 # The value could be 1 to nrow(MYGRID)=3000; here we just simulate one data set.
scn   <- MYGRID$scn[SEG]
k_fit <- 2#MYGRID$k_fit[SEG] 
iter  <- MYGRID$iter[SEG] 
rep   <- MYGRID$rep[SEG] 


# current parameters:
curr_mix <- subclass_mix_seq[iter]
lambda   <- c(0.5,0.5) #c(curr_mix,1-curr_mix)
eta      <- c(curr_mix,1-curr_mix) 

# set fixed simulation sequence:
seed_start <- 20161215  
set.seed(seed_start+seed_seq[SEG])

if (scn == 3){
  ThetaBS_withNA <- cbind(c(0.95,0.95,0.55,0.95,0.95,0.95),
                          c(0.95,0.55,0.95,0.55,0.55,0.55))
  PsiBS_withNA   <- cbind(c(0.4,0.4,0.05,0.2,0.2,0.2),
                          c(0.05,0.05,0.4,0.05,0.05,0.05))
}

if (scn == 2){
  ThetaBS_withNA <- cbind(c(0.95,0.9,0.85,0.9,0.9,0.9),
                          c(0.95,0.9,0.95,0.9,0.9,0.9))
  PsiBS_withNA   <- cbind(c(0.3,0.3,0.15,0.2,0.2,0.2),
                          c(0.15,0.15,0.3,0.05,0.05,0.05))
}

if (scn == 1){
  ThetaBS_withNA <- cbind(c(0.95,0.9,0.9,0.9,0.9,0.9),
                          c(0.95,0.9,0.9,0.9,0.9,0.9))
  PsiBS_withNA   <- cbind(c(0.25,0.25,0.2,0.15,0.15,0.15),
                          c(0.2,0.2,0.25,0.1,0.1,0.1))
}



# the following paramter names are set using names in the 'baker' package:
set_parameter <- list(
  cause_list      = c(LETTERS[1:J]),
  etiology        = c(0.5,0.2,0.15,0.05,0.05,0.05),# same length as cause_list.
  pathogen_BrS    = LETTERS[1:J],
  meas_nm         = list(MBS = c("MBS1")), # a single source of Bronze Standard (BrS) data.
  Lambda          = lambda,              #ctrl mix (subclass weights).
  Eta             = t(replicate(J,eta)), #case mix; # of rows equals length(cause_list).
  PsiBS           = PsiBS_withNA,
  ThetaBS         = ThetaBS_withNA,
  Nu      =     N, # control sample size.
  Nd      =     N  # case sample size.
)

# # visualize pairwise log odds ratios for cases and controls when eta changes 
# # from 0 to 1. In the following simulation, we just use one value: eta=0.
# example("compute_logOR_single_cause")

simu_out   <- simulate_nplcm(set_parameter)
data_nplcm <- simu_out$data_nplcm

#
# 2. Exploratory Data Analysis:
#

# specify cause list:
cause_list <- set_parameter$cause_list

# specify measurements:
# bronze-standard measurements:
patho_BrS_MBS1      <- set_parameter$pathogen_BrS
BrS_object_1        <- make_meas_object(patho_BrS_MBS1,"MBS","1","BrS",cause_list)
   # please use ?make_meas_object to see the measurement standards.


# pairwise log odds ratio plot:
pathogen_display <- BrS_object_1$patho
plot_logORmat(data_nplcm,pathogen_display,1)


#
# 3. Specify model:
#

m_opt1 <- list(likelihood   = list(cause_list = cause_list,               # <---- fitted causes.
                                   k_subclass = k_fit,                    # <---- no. of subclasses.
                                   Eti_formula = "~ 0",                   # <---- only apply FPR formula to specified slice of measurements; if not default to the first slice.
                                   FPR_formula = list(MBS1 = "~0")),      # <---- etiology regression formula.
               use_measurements = c("BrS"),                               # <---- which measurements to use to inform etiology
               prior        = list(Eti_prior   = overall_uniform(1, cause_list) ,                       # <--- etiology prior. 
                                   TPR_prior   = list(
                                     BrS  = list(info  = "informative",
                                                 input = "direct_beta_param",
                                                 val   = list(
                                                          MBS1 = list(alpha = list(rep(6,length(set_parameter$pathogen_BrS))),
                                                                      beta  = list(rep(2,length(set_parameter$pathogen_BrS)))
                                                                     )
                                                 )
                                                 
                                     )#,
                                     #SS  = list(info = "informative",
                                     #           input = "match_range",
                                     #           val = list(
                                     #             MSS1 = list(list(up = rep(0.2,length(set_parameter$pathogen_SS)),
                                     #                              low = rep(0.1,length(set_parameter$pathogen_SS))
                                     #             )
                                     #             )
                                     #           )
                                     #)
                                     
                                   )# <---- TPR prior.
               )
)                       

model_options <- m_opt1
assign_model(model_options,data_nplcm)

#
# 4. Fit model:
#

# date stamp for analysis:
Date     <- gsub("-", "_", Sys.Date())
# include stratification information in file name:
dated_strat_name    <- file.path(working_dir,paste0("scn_",scn,"_mixiter_",iter))

# create folder
dir.create(dated_strat_name)
fullname <- dated_strat_name

# for finer scenarios, e.g., different types of analysis applicable to the
# same data set. Here we just perform one analysis:
result_folder <- file.path(fullname,paste0("rep_",rep,"_kfit_",model_options$likelihood$k_subclass))
dir.create(result_folder)


# options for MCMC chains:
mcmc_options <- list(debugstatus = !TRUE,
                     individual.pred = !TRUE,
                     ppd             = TRUE,
                     n.chains   = 1,
                     n.itermcmc = 100, #50000
                     n.burnin   = 1, #10000
                     n.thin     = 1, #50
                     result.folder = result_folder,
                     bugsmodel.dir = result_folder,#"C:\\winbugs_model_package\\",
                     #winbugs.dir   = "C:\\Program Files\\WinBUGS14\\"
                     jags.dir = "",
                     use_jags = TRUE
)

# Record the settings of current analysis:
# data clean options:
clean_options <- list (#raw_meas_dir       =  file.path("~/data/perch","PQ_27JUL15.csv"), # <-------- where to look for raw data.
  BrS_objects        =  make_list(BrS_object_1),         # <---- all bronze-standard measurements.
  patho_taxo_dir     = file.path(working_dir,"pathogen_category_simulation.csv"),# <---- where to look for pathogen taxonomy information.
  allow_missing      = FALSE)    

dput(clean_options,file.path(mcmc_options$result.folder,"data_clean_options.txt"))

#
# 4.WinBUGS fitting:
#
gs <- nplcm(data_nplcm,model_options,mcmc_options)

#
# 5. visualize results:
#

result_folder <- mcmc_options$result.folder

# plot data, prior, and posteriors for all causitive pathogens:
pdf(file.path(result_folder,"panels_plot.pdf"), height=10, width =20)
suppressWarnings(plot_panels(result_folder,bg_color=NULL))
dev.off()

# plot data, prior, and posterior for selected causes:
pdf(file.path(result_folder,"panels_plot_selected.pdf"), height=3, width =20)
plot_panels(result_folder,bg_color=NULL, 
            select_latent = c("A","C"),exact=TRUE)
dev.off()

# plot the joint posterior of the etiology fraction for any three causes:
pdf(file.path(result_folder,"pick_three.pdf"), height=10, width =10)
plot_selected_etiology(selected = c("A","B","C"), result_folder, 1, 5)
dev.off()

# grouped etiology (e.g., bacteria (left) vs virus (right) )
download.file("https://raw.githubusercontent.com/zhenkewu/baker_example/master/pathogen_category_simulation.csv", file.path(working_dir,"pathogen_category_simulation.csv"))

pdf(file.path(result_folder,"group_etiology.pdf"),height=15,width=15)
plot_group_etiology(result_folder,dir_taxo = file.path(working_dir,
                                                       "pathogen_category_simulation.csv"))
dev.off()

# model checking by comparing observed pairwise log odds ratios (LOR)
# to the posterior predictive distributions of pairwise LOR; The numbers are
# (predicted LOR - observed LOR)/ s.e. (posterior predictive distribution of LOR);
# The closer to zero the better.
pdf(file.path(result_folder,"checking_SLORD.pdf"), height=10, width =15)
plot_check_pairwise_SLORD(result_folder,slice=1)
dev.off()

# model checking by comparing observed frequencies of binary patterns to 
# the model-predicted ones.
dir_list <- as.list(c(result_folder))
pdf(file.path(result_folder,"check_common_pattern.pdf"), height=10, width =15)
plot_check_common_pattern(dir_list,slice_vec =c(1,1))
dev.off()


